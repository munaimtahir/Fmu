from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.filters import OrderingFilter, SearchFilter
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response

from sims_backend.common_permissions import \
    IsAdminOrRegistrarReadOnlyFacultyStudent

from .models import Attendance
from .serializers import AttendanceSerializer
from .utils import (calculate_attendance_percentage, check_eligibility,
                    get_section_attendance_summary)


class AttendanceViewSet(viewsets.ModelViewSet):
    queryset = Attendance.objects.all()
    serializer_class = AttendanceSerializer
    permission_classes = [IsAuthenticated, IsAdminOrRegistrarReadOnlyFacultyStudent]
    filter_backends = [SearchFilter, OrderingFilter]
    search_fields = ["section__course__code", "student__reg_no", "date"]
    ordering_fields = ["id", "date"]

    @action(detail=False, methods=["get"], url_path="percentage")
    def attendance_percentage(self, request):
        """Get attendance percentage for a student in a section."""
        student_id = request.query_params.get("student_id")
        section_id = request.query_params.get("section_id")

        if not student_id or not section_id:
            return Response(
                {"error": "student_id and section_id are required"},
                status=400,
            )

        try:
            percentage = calculate_attendance_percentage(
                int(student_id), int(section_id)
            )
            return Response({"percentage": percentage})
        except Exception as e:
            return Response({"error": str(e)}, status=400)

    @action(detail=False, methods=["get"], url_path="eligibility")
    def check_eligibility_endpoint(self, request):
        """Check if a student is eligible based on attendance."""
        student_id = request.query_params.get("student_id")
        section_id = request.query_params.get("section_id")
        threshold = request.query_params.get("threshold", "75.0")

        if not student_id or not section_id:
            return Response(
                {"error": "student_id and section_id are required"},
                status=400,
            )

        try:
            result = check_eligibility(
                int(student_id), int(section_id), float(threshold)
            )
            return Response(result)
        except Exception as e:
            return Response({"error": str(e)}, status=400)

    @action(detail=False, methods=["get"], url_path="section-summary")
    def section_summary(self, request):
        """Get attendance summary for a section."""
        section_id = request.query_params.get("section_id")

        if not section_id:
            return Response(
                {"error": "section_id is required"},
                status=400,
            )

        try:
            summary = get_section_attendance_summary(int(section_id))
            return Response(summary)
        except Exception as e:
            return Response({"error": str(e)}, status=400)
